#!/bin/bash

# set -ue
set -o errexit
set -o nounset
# find the real username and home directory: for some reason docker overrides
# $HOME and $USER
USER=$( whoami )
HOME=$( eval echo ~$USER )
# don't use sudo if current user is root
[[ $USER == 'root' ]] && sudo='' || sudo=sudo

main(){
  # abort if current user can sudo
  [[ $USER == 'root' ]] || sudo -l >/dev/null || exit 1
  # configure locale if root
  [[ $USER == 'root' ]] && locale-gen en_CA.utf8 && update-locale LANG=en_CA.utf8
  # install files
  if ! $( which rcup >/dev/null ); then
    install rcm
  fi
  install_dotfiles
  echo "all set!" >& 2
}

install() {
  package=$1
  echo "Installing $package"
  case $package in
    rcm)
      deb_src='http://thoughtbot.github.io/rcm/debs/rcm_1.2.1-2_all.deb'
      bob=$( echo ~$USER )
      deb_dst=$HOME/rcm.deb
      wget "$deb_src" --output-document=$deb_dst
      $sudo dpkg -i $deb_dst
      ;;
    *)
      $sudo apt-get install -y $package
      ;;
  esac
}

install_dotfiles(){
  rcup -f -d "$( dirname $0 )"
  # install pubkey from github
  ssh_conf_dir=$HOME/.ssh
  mkdir -p "$ssh_conf_dir" && chmod 700 "$ssh_conf_dir"
  authorized_keys=$ssh_conf_dir/authorized_keys
  # the ssh-import-id package currently does not
  touch $authorized_keys && chmod 600 $authorized_keys
  if which ssh-import-id >/dev/null 2>&1; then
    version=$( $sudo dpkg -l | grep ssh-import-id | awk '{ print $3 }' )
    if [[ $version =~ ^3. ]]; then
      # ssh-import-id 2.* does not support GitHub
      ssh-import-id gh:amirkdv
      return
    fi
  fi
  url='https://api.github.com/users/amirkdv/keys'
  echo "ssh-import-id not found, accessing $url" >& 2
  wget -qO- "$url" | grep key | cut -d'"' -f4 >> "$authorized_keys"
}

main
